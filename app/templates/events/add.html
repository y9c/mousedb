{% extends "base.html" %}
{% block content %}

    {% load static %}


    <script src="{% static 'js/tableExport.js' %}"></script>
    <script src="{% static 'js/bootstrap-editable.js' %}"></script>
    <script src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/daterangepicker.js' %}"></script>

    <link rel="stylesheet" href="{% static 'css/bootstrap-editable.css' %}">
    <link rel="stylesheet" href="{% static 'css/daterangepicker.css' %}">



    <div class="panel panel-default">
        <div class="panel-heading">
            STEP 1: Select breed or mouse source
        </div>

        <div class="panel-body">
            <div class="row">
                <label class="control-label col-sm-2" for="line_query">
                    自交后代
                </label>
                <div class="col-sm-3">
                    <select class="form-control" id="breedID">
                        <option value="">选择BREED</option>
                    </select>
                </div>
                <div class="col-sm-2  col-sm-offset-1">
                    <input type="number" id="breedCount" class="form-control" placeholder="NUM" required>
                </div>
                <div class="col-sm-2 col-sm-offset-1">
                    <input id="creat" class="btn btn-primary" type="button" onclick="createTable()" value="Create the table">
                </div>
            </div>

            <hr>
            <div class="row">
                <label class="control-label col-sm-2" for="line_query">
                    购买小鼠
                </label>
                <div class="col-sm-3">
                    <select class="form-control" id="xxxx">
                        <option value="">购买来源</option>
                    </select>
                </div>
                <div class="col-sm-2 col-sm-offset-1">
                    <input type="number" id="xxxx" class="form-control" placeholder="NUM" required>
                </div>
                <div class="col-sm-2 col-sm-offset-1">
                    <input id="creat" class="btn btn-primary" type="button" onclick="createTable()" value="Create the table">
                </div>
            </div>
        </div>
    </div>




    <div class="container">
        <table id="myTable" class="table table-inverse text-center"></table>
    </div>

    <div class="container jumbotron">
        <div class="row">
            <div class="col-xs-9 col-md-offset-1">
                <h2 class="form-signin-heading">Submit Form</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-2 col-md-offset-2">
                <button id="submit" class="btn btn-primary" type="submit">Submit Go!!</button>
            </div>
        </div>
    </div>



    <div class="container">
        <div class="row">
            <div class="col-xs-9">
                <div id="hello_response"></div>
            </div>
        </div>
    </div>


    <script>

        //获取下拉列表
        $(document).ready(function () {
            $.ajax({
                url: "/api/getlist-breed",
                method: "GET",
                data: {line: $(this).val()},
                dataType: "json",
                async: false,
                success: function (data) {
                    console.log(data);
                    var $el = $("#breedID");
                    $el.empty(); // remove old options
                    $.each(data, function (key, value) {
                        $el.append($("<option></option>")
                                .attr("value", value).text(key));
                    });
                },
            });
        })


        //For getting CSRF token
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // Build a form
        function createTable() {
            var breedID = $('#breedID').val();
            var breedCount = $('#breedCount').val();
            var form = [];
            for (var r = 0; r < parseInt(breedCount, 10); r++) {
                form.push({
                    'Breed': breedID,
                    'Pup': r + 1,
                    'Gen': "请选择基因型",
                    'Keep': "0"
                });
            }
            $('#myTable').bootstrapTable('load', form)
            $('#myTable').bootstrapTable({
                data: form,
                search: true,
                columns: [ {
                    field: 'Breed',
                    title: 'Breed',
                    sortable: true,
                }, {
                    field: 'Pup',
                    title: 'Pup',
                    sortable: true,
                }, {
                    field: 'Gen',
                    title: 'Gen',
                    sortable: true,
                    editable: {
                        type: 'select',
                        title: 'Gen',
                        emptytext: '请选择基因型',
                        source: [{
                            value: "WT-X",
                            text: "S(XX)"
                        }, {
                            value: "WT-Y",
                            text: "S(XY)"
                        }, ],
                    },
                }, {
                    field: 'Keep',
                    title: 'Keep',
                    sortable: true,
                    editable: {
                        type: 'select',
                        title: 'Keep',
                        source: [{
                            value: "0",
                            text: "Discard"
                        }, {
                            value: "1",
                            text: "Keep"
                        }, ],
                    },
                }, ]

            });
        };

        //For doing AJAX post
        $("#submit").click(function(e) {

            e.preventDefault();

            var myRows = [];
            var headersText = [];
            var $headers = $("#myTable th");

            // Loop through grabbing everything
            var $rows = $("#myTable tbody tr").each(function(index) {
                $cells = $(this).find("td");
                myRows[index] = {};
                $cells.each(function(cellIndex) {
                    if (headersText[cellIndex] === undefined) {
                        headersText[cellIndex] = $($headers[cellIndex]).text();
                    }
                    myRows[index][headersText[cellIndex]] = $(this).text();
                });
            });


            var csrftoken = getCookie('csrftoken');
            var breedID = $('#breedID').val();
            var breedCount = $('#breedCount').val();
            //This is the Ajax post.Observe carefully. It is nothing but details of where_to_post,what_to_post

            $.ajax({
                url: "/api/mouse-event-submit",
                // url: window.location.href,
                type: "POST",
                data: {
                    csrfmiddlewaretoken: csrftoken,
                    breedID: breedID,
                    breedCount: breedCount,
                    breedBirth: JSON.stringify(myRows),
                },
                success: function(response) {
                    console.log(response);
                    $('#hello_response').bootstrapTable('append', [JSON.parse(response)]);
                    $('#hello_response').bootstrapTable({
                        data: [JSON.parse(response)],
                        columns: [{}, {
                            field: 'breedCount',
                            title: 'breedCount'
                        }, {
                            field: 'mate_start_date',
                            title: 'mate_start_date'
                        }, {
                            field: 'mate_end_day',
                            title: 'mate_end_day'
                        }, {
                            field: 'born_date',
                            title: 'born_date'
                        }, ]

                    });
                },
                error: function(xhr, errmsg, err) {
                    //console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        });
    </script>



{% endblock %}
